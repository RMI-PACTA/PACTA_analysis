# TODO: 
# Emissions factors aggregations for each portfolio
# Clean up sectors options
# Functionalise saving
# Tech share? if yes, then complete function
# 


port_col_types <- set_col_types(grouping_variables, "ddddccccddcl")
##################
##### EQUITY #####
##################

equity_input_file <- paste0(proc_input_path, "/",project_name, "_equity_portfolio.csv")

if(file.exists(equity_input_file)){
  port_raw_all_eq <- read_csv(equity_input_file, col_types = port_col_types) %>% 
    mutate(id = as.character(id))
  
  ald_scen_eq <- get_ald_scen("Equity")
  
  ald_raw_eq <- get_ald_raw("Equity")
  
  
  list_investors_eq <- unique(port_raw_all_eq$investor_name)
  
  for (e in 1:length(list_investors_eq) ){
    map_eq <- NA
    company_all_eq <- NA
    port_all_eq <- NA
    
    investor_name_select <- list_investors_eq[e]
    print(paste0(e, ": ", investor_name_select))
    
    port_raw_eq <- port_raw_all_eq %>% filter(investor_name == investor_name_select)
    
    port_eq <- calculate_weights(port_raw_eq, "Equity", grouping_variables)
    
    company_port_weight <- port_eq %>% 
      group_by(id) %>% 
      summarise(company_port_weight = sum(port_weight)) %>% 
      select(id, company_port_weight)
    
    port_eq <- merge_in_ald(port_eq, ald_scen_eq)
    
    port_eq <- port_eq %>% left_join(company_port_weight, by = c("id"))
    
    # Portfolio weight methodology
    port_pw_eq <- port_weight_allocation(port_eq, "Equity")
    
    company_pw_eq <- aggregate_company(port_pw_eq)
    
    port_pw_eq <- aggregate_portfolio(company_pw_eq) 
    
    
    # Ownership weight methodology
    port_own_eq <- ownership_allocation(port_eq)
    
    company_own_eq <- aggregate_company(port_own_eq)
    
    port_own_eq <- aggregate_portfolio(company_own_eq) 
    
    
    # Create combined outputs
    company_all_eq <- bind_rows(company_pw_eq, company_own_eq)
    
    port_all_eq <- bind_rows(port_pw_eq, port_own_eq) 
    
    if(has_map){
      
      map_eq <- merge_in_geography(company_all_eq, ald_raw_eq, sectors_for_maps)
      
      map_eq <- aggregate_map_data(map_eq)
      
    } 
    
    # Technology Share Calculation
    port_all_eq <- calculate_technology_share(port_all_eq)
    
    company_all_eq <- calculate_technology_share(company_all_eq)
    
    # Scenario alignment calculations
    port_all_eq <- calculate_scenario_alignment(port_all_eq)
    
    company_all_eq <- calculate_scenario_alignment(company_all_eq)
    
    # map needs the "complete" function built in if this is necessary
    
    
    investor_results_path <- paste0(results_path,"/", investor_name_select, "/") 
    if(!dir.exists(investor_results_path)){dir.create(investor_results_path)}
    
    if(nrow(company_all_eq)>0){ write_rds(company_all_eq, paste0(investor_results_path, "Equity_results_company.rda"))}
    if(nrow(port_all_eq)>0){write_rds(port_all_eq, paste0(investor_results_path, "Equity_results_portfolio.rda"))}
    if(has_map){if(nrow(map_eq)>0){write_rds(map_eq, paste0(investor_results_path, "Equity_results_map.rda"))}}
    
  }
}

#################
##### BONDS #####
#################

bonds_inputs_file <- paste0(proc_input_path, "/",project_name, "_bonds_portfolio.csv")

if (file.exists(bonds_inputs_file)){
  
  port_raw_all_cb <- read_csv(bonds_inputs_file, col_types = port_col_types) %>% 
    mutate(id = as.character(id))
  
  
  ald_scen_cb <- get_ald_scen("Bonds")
  
  ald_raw_cb <- get_ald_raw("Bonds")
  
  
  list_investors_cb <- unique(port_raw_all_cb$investor_name)
  
  for (b in 1:length(list_investors_cb) ){
    map_cb <- NA
    company_all_cb <- NA
    port_all_cb <- NA
    
    investor_name_select <- list_investors_cb[b]
    print(paste0(b, ": ", investor_name_select))
    
    port_raw_cb <- port_raw_all_cb %>% filter(investor_name == investor_name_select)
    
    port_cb <- calculate_weights(port_raw_cb, "Bonds", grouping_variables) 
    
    company_port_weight <- port_cb %>% 
      group_by(id) %>% 
      summarise(company_port_weight = sum(port_weight)) %>% 
      select(id, company_port_weight)
    
    port_cb <- merge_in_ald(port_cb, ald_scen_cb) %>% 
      mutate(ald_sector = ifelse(ald_sector == financial_sector, ald_sector, "Other"))
    
    port_cb <- port_cb %>% left_join(company_port_weight, by = c("id"))
    
    # Portfolio weight methodology
    port_pw_cb <- port_weight_allocation(port_cb, "Bonds")
    
    company_pw_cb <- aggregate_company(port_pw_cb)
    
    port_pw_cb <- aggregate_portfolio(company_pw_cb) 
    
    
    
    # Create combined outputs
    company_all_cb <- company_pw_cb
    
    port_all_cb <- port_pw_cb
    
    if(has_map){
      
      if(data_check(company_all_cb)){
        map_cb <- merge_in_geography(company_all_cb, ald_raw_cb, sectors_for_maps)
        
        map_cb <- aggregate_map_data(map_cb)
      }  
    } 
    
    # Technology Share Calculation
    port_all_cb <- calculate_technology_share(port_all_cb)
    
    company_all_cb <- calculate_technology_share(company_all_cb)
    
    # Scenario alignment calculations
    port_all_cb <- calculate_scenario_alignment(port_all_cb)

    company_all_cb <- calculate_scenario_alignment(company_all_cb)
    
    # map needs the "complete" function built in if this is necessary
    
    
    investor_results_path <- paste0(results_path,"/", investor_name_select, "/") 
    if(!dir.exists(investor_results_path)){dir.create(investor_results_path)}
    
    if(nrow(company_all_cb)>0){ write_rds(company_all_cb, paste0(investor_results_path, "Bonds_results_company.rda"))}
    if(nrow(port_all_cb)>0){write_rds(port_all_cb, paste0(investor_results_path, "Bonds_results_portfolio.rda"))}
    if(has_map){if(nrow(map_cb)>0){write_rds(map_cb, paste0(investor_results_path, "Bonds_results_map.rda"))}}
    
    
  }
  
}


#####################
##### AGGREGATE #####
#####################


### TODO: Move function to function script in case it suits our needs @Clare, can you check this?
gather_and_save_project_results <- function(results_folder_path = results_path, aggregation_level = "portfolio", portfolios_per_file = 500, year_filter = NA, allocation_filter = NA){
  
  all_investors <- list.dirs(results_folder_path)
  all_investors <- basename(all_investors)[-1]
  
  all_results_cb <- NA
  all_results_eq <- NA
  
  k <- 1
  j <- 1
  
  for (i in 1:length(all_investors)){
    
    investor_name_select <- all_investors[i]
    print(investor_name_select)
    
    results_path_investor <- paste0(results_path,"/",investor_name_select,"/")
    
    if(file.exists(paste0(results_path_investor,"/Equity_results_",aggregation_level,".rda"))){
      
      results_eq <- as.data.frame(read_rds(paste0(results_path_investor,"/Equity_results_",aggregation_level,".rda")))
      
      if(typeof(year_filter) %in% c("integer","double")){
        results_eq <- results_eq %>% filter(year %in% year_filter)
      }
      
      if(typeof(allocation_filter) %in% c("character")){
        results_eq <- results_eq %>% filter(allocation %in% allocation_filter)
      }
      
      if(nrow(results_eq)!=0){
      if (!is.na(all_results_eq)){
        all_results_eq <- rbind(all_results_eq, results_eq)
      }else{
        all_results_eq <- results_eq
      }}
      
    }
    
    if(file.exists(paste0(results_path_investor,"Bonds_results_",aggregation_level,".rda"))){
      
      results_cb <- read_rds(paste0(results_path_investor,"Bonds_results_",aggregation_level,".rda"))
      
      if(typeof(year_filter) %in% c("integer","double")){
        results_cb <- results_cb %>% filter(year %in% year_filter)
      }
      
      if(typeof(allocation_filter) %in% c("character")){
        results_cb <- results_cb %>% filter(allocation %in% allocation_filter)
      }
      
      if (!is.na(all_results_cb)){
        all_results_cb <- rbind(all_results_cb, results_cb)
      }else{
        all_results_cb <- results_cb
      }
    }
    
    
    if (j==portfolios_per_file){
      if(exists("all_results_cb")){
        saveRDS(all_results_cb,paste0(results_path,"/Bonds_results_",aggregation_level,"_",k,".rda"))
        rm(all_results_cb)}
      if(exists("all_results_eq")){
        saveRDS(all_results_eq,paste0(results_path,"/Equity_results_",aggregation_level,"_",k,".rda"))
        rm(all_results_eq)}
      j = 1
      k = k + 1
    }else{
      j = j + 1
    }
  }
  
  if(exists("all_results_cb")){
    saveRDS(all_results_cb,paste0(results_path,"/Bonds_results_",aggregation_level,".rda"))}
  if(exists("all_results_eq")){
    saveRDS(all_results_eq,paste0(results_path,"/Equity_results_",aggregation_level,".rda"))}
  
} 


gather_and_save_project_results(results_path, aggregation_level = "portfolio")
gather_and_save_project_results(results_path, aggregation_level = "company", year_filter = c(START.YEAR(),START.YEAR()+5), allocation_filter = "portfolio_weight", portfolios_per_file = 100)


