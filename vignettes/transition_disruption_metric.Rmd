---
title: "Transition Disruption Metric"
# author: "Jackson Hoffart"
# output: rmarkdown::html_vignette
# vignette: >
#   %\VignetteIndexEntry{transition_disruption_metric}
#   %\VignetteEngine{knitr::rmarkdown}
#   %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(dplyr)
library(ggplot2)
library(PACTA.analysis)
```

# Introduction

PACTA offers many different metrics, each with their own strengths and weaknesses. Most of the metrics rely heavily on the use of forward-looking data. This data, which estimates the production of physical assets, is reliably predictable to about five years into the future. 

There are, however, certain climate scenarios which deliberately offset the bulk of their ambition to the later years in the scenario. For example, a "delayed response" scenario (such as the  Inevitable Policy Response (IPR) Scenario) assumes that future production of most sectors follow current trends (i.e. business as usual), before inevitably resulting in a massive and disruptive transition in the long-term. Since the interesting part of these scenarios is often positioned well beyond the 5 year time-horizon of the data, most usual PACTA metrics (eg. Volume Trajectory) are ill-suited to provide useful insights. 

The purpose of these "delayed response" scenarios is to estimate the risks associated with a "worst-case scenario". With such a scenario, we might want to measure how **disruptive** a climate **transition** could be to the portfolio.  

To help provide insights into this question, we propose the Transition Disruption Metric (TDM). This metric aims to provide useful insights in the medium- to long- term (ie. time-horizons greater than 5 years).

# Inspiration

We will design the metric in a few steps. Consider some function, $S(t)$, that in general might increase or decrease over time:

```{r, echo = FALSE}

data <- tibble::tribble(
  ~production, ~year, ~type,
  1L, 2020L, "S(t)",
  2L, 2025L, "S(t)",
  3L, 2030L, "S(t)",
  4L, 2035L, "S(t)",
  5L, 2040L, "S(t)",
  6L, 2045L, "S(t)",
  7L, 2050L, "S(t)",
  1L, 2025L, "P(t)"
)

data %>%
  filter(type == "S(t)") %>%
  ggplot(aes(x = year, y = production, group = type)) +
  geom_line(aes(color = type)) +
  scale_color_manual(values = c("#CC6666", "#9999CC")) +
  geom_point(aes(shape = type)) + 
  scale_shape_manual(values = c("circle", "triangle")) +
  labs(title = "Production by Year", x = "Year", y = "Production") + 
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank()
  )
```

This function could represent some climate scenario, dictating how production should change to mitigate climate change. Now, let's say we know the production associated with a portfolio for the range $(t,t + t_1)$, where in general, $t + t_1$ will be less than the end year of the scenario:
```{r, echo = FALSE}

data <- tibble::tribble(
  ~production, ~year, ~type,
  1L, 2020L, "S(t)",
  2L, 2025L, "S(t)",
  3L, 2030L, "S(t)",
  4L, 2035L, "S(t)",
  5L, 2040L, "S(t)",
  6L, 2045L, "S(t)",
  7L, 2050L, "S(t)",
  0.5L, 2020L, "P(t)",
  1L, 2025L, "P(t)"
)

data %>%
  ggplot(aes(x = year, y = production, group = type)) +
  geom_line(aes(color = type)) +
  scale_color_manual(values = c("#9999CC", "#CC6666")) +
  geom_point(aes(shape = type)) +
  scale_shape_manual(values = c("triangle", "circle")) +
  labs(title = "Production by Year", x = "Year", y = "Production") + 
  theme(
    axis.text.y = element_blank()
  ) + 
  scale_x_continuous(
    breaks = c(2020, 2025, 2030, 2035, 2040, 2045, 2050),
    labels = c("t", "t+t1", "", "", "", "", "")
    )
```

We are now comparing projected portfolio data (accurate to the best of our knowledge) against a scenario's production projections. We want to try to understand how disrupted this portfolio might be at some point further in the future, call it $t+t_2$. To do so, let's draw a line connecting the portfolio, at the furthest date in the future that we have data ($t+t_1$), to the scenario value at $t+t_2$

```{r, echo = FALSE}

data <- tibble::tribble(
  ~production, ~year,                ~type, ~line_type,
            1, 2020L,               "S(t)",    "solid",
            2, 2025L,               "S(t)",    "solid",
            3, 2030L,               "S(t)",    "solid",
            4, 2035L,               "S(t)",    "solid",
            5, 2040L,               "S(t)",    "solid",
            6, 2045L,               "S(t)",    "solid",
            7, 2050L,               "S(t)",    "solid",
          0.5, 2020L,               "P(t)",    "solid",
            1, 2025L,               "P(t)",    "solid",
            1, 2025L, "Required build-out",   "dashed",
            3, 2030L, "Required build-out",   "dashed"
  )

data %>%
  ggplot(aes(x = year, y = production, group = type)) +
  geom_line(aes(color = type, linetype = line_type)) +
  scale_color_manual(values = c("#9999CC", "#0B7A75", "#CC6666")) +
  guides(linetype = "none") +
  scale_linetype_manual(values = c("dashed", "solid")) + 
  guides(fill = "none") +
  geom_point(aes(shape = type)) +
  scale_shape_manual(values = c("triangle", "triangle", "circle")) +
  labs(title = "Production by Year", x = "Year", y = "Production") + 
  theme(
    axis.text.y = element_blank()
  ) + 
  scale_x_continuous(
    breaks = c(2020, 2025, 2030, 2035, 2040, 2045, 2050),
    labels = c("t", "t+t1", "t+t2", "", "", "", "")
    )
```

Suppose now we wish to compare the slope of the scenario, $m_S$ and the slope of the *required future build-out* of the portfolio, $m_P$ (that is, the slope of the dashed line in the above plot). 

The slope of the scenario, between $(t, t+t2)$ is: 

$$ m_S = \frac{S(t+t_2) - S(t)}{(t+t_2) - (t)} $$ 

To calculate the slope of the portfolio's required build-out, we have constructed this line to connect $P(t+t_1)$ and $S(t+t_2)$, thus the slope will be: 

$$ m_P = \frac{S(t+t_2) - P(t+t_1)}{(t+t_2) - (t+t_1)}$$

Taking the ratio of these two slopes, and tidying up a bit, yields: 

$$\frac{m_P}{m_S} = \frac{S_i (t+t_2) - P_i(t+t_1)}{S_i(t+t_2) - S_i(t)} * \left(\frac{t_2}{t_2-t_1}\right)$$

We will use this value as the basis for our metric. To understand what this value shows, let's explore a few boundary cases: 

- First of all, if $m_P$ is $0$, meaning that the portfolio has already achieved the future scenario target, then the ratio will be 0. 

- If $m_P = m_S$, meaning that the portfolio has not achieved the future scenario target, but is exactly on track with the current scenario value, then the ratio will be 1. 

- Any value between $0$ and $1$ means that the portfolio is currently performing equal to or better than the scenario. 

- For values greater than $1$, the portfolio is lagging the scenario and needs to have a LARGER rate of change than the scenario, to achieve the future targets. 

The final boundary case will be assessing when the value is positive or negative. 
It is clear that it will be positive if $m_P$ is less than $0$, meaning that the portfolio needs to increase to meet the scenario AND $m_S$ is positive,  the ratio will be negative. 

In this final case, we don't necessarily need a metric as we don't expect the portfolio to be disrupted if it is already out-performing against the scenario, so we can attenuate negative values: 

$$max\left(0, \frac{m_P}{m_S}\right)$$

# Metric Definition

Based on the above, we define the transition disruption metric $TDM$, for some technology, $i$ as: 

$$TDM_i = max\left(0, \frac{S_i (t+t_2) - P_i(t+t_1)}{S_i(t+t_2) - S_i(t)} * \left(\frac{t_2}{t_2-t_1}\right)\right) $$

where: 

- $S_i(t)$ is the scenario production of technology $i$ at year $t$
- $P_i(t)$ is the portfolio production of technology $i$ at year $t$
- $t_2$ is some long interval, against which the disruption is measured overall
- $t_1$ is some interval, where $t_1 < t_2$, against which future disruption is measured 

In the special case that $t_2 = 10$ and $t_1 = 5$, this metric reduces to: 

$$TDM_i = 2 * max\left(0, \frac{S_i (t+10) - P_i(t+5)}{S_i(t+10) - S_i(t)}\right) $$

<!-- # Edge Cases -->
<!-- ## Upper limit -->
<!-- Given that we can assume both $S(t)$ and $P(t)$ are positive, it is clear that the numerator is bound by $S(t)$. Thus, the most obvious boundary to consider occurs when $S_i(t+10)$ approaches $S_i(t)$. In this case, we see that the $TDM$ approaches infinity.  -->

<!-- How can we interpret this?  -->

<!-- Let's plot a completely flat scenario, against two different production values, one which is above the flat scenario, and one which is below it:  -->

<!-- ``` {r, echo = FALSE} -->
<!-- suppressPackageStartupMessages(library(tidyverse)) -->

<!-- data <- tibble::tribble( -->
<!--   ~year, ~metric, ~production, -->
<!--   2020L,    "P1",          5L, -->
<!--   2025L,    "P1",          6L, -->
<!--   2030L,    "P1",          7L, -->
<!--   2050L,    "P1",          8L, -->
<!--   2020L,    "P2",         15L, -->
<!--   2025L,    "P2",         14L, -->
<!--   2030L,    "P2",         13L, -->
<!--   2050L,    "P2",         12L, -->
<!--   2020L,     "S",         10L, -->
<!--   2025L,     "S",         10L, -->
<!--   2030L,     "S",         10L, -->
<!--   2050L,     "S",         10L -->
<!-- ) -->


<!-- data %>% -->
<!--   ggplot(aes(x = year, y = production, group = metric, color = metric)) + -->
<!--   geom_line() + -->
<!--   labs(title = "Trajectories for Two Portfolios", x = "Year", y = "Production") -->
<!-- ``` -->

<!-- Notice that, since the scenario here is completely flat, the $TDM$ will be undefined. But this actually makes sense, since in general, we have no way of determining which portfolio will be "disrupted" in this case, since we don't know if it is preferable to be above or below the scenario.  -->

<!-- Another interesting point is that the $TDM$ will blow up as the scenario becomes more shallow. Let's consider two cases. In both cases, the portfolio will have the exact same values, and the scenario will have the same value of $S(t+10)$. However, the second case scenario will be more shallow than the first:  -->

<!-- ``` {r, echo = FALSE} -->

<!-- data <- tibble::tribble( -->
<!--   ~year, ~metric, ~production, -->
<!--   2020L,     "P",          5L, -->
<!--   2025L,     "P",          5L, -->
<!--   2030L,     "P",          5L, -->
<!--   2050L,     "P",          5L, -->
<!--   2020L,     "S",          5L, -->
<!--   2025L,     "S",         10L, -->
<!--   2030L,     "S",         12L, -->
<!--   2050L,     "S",         15L -->
<!-- ) -->

<!-- data %>% -->
<!--   ggplot(aes(x = year, y = production, group = metric, color = metric)) + -->
<!--   geom_line() + -->
<!--   labs(title = "Trajectories for Two Portfolios", x = "Year", y = "Production") -->
<!-- ``` -->

<!-- the resulting TDM here is:  -->
<!-- ```{r} -->
<!-- (12 - 5) / (12 - 5) -->
<!-- ``` -->

<!-- ``` {r, echo = FALSE} -->

<!-- data <- tibble::tribble( -->
<!--   ~year, ~metric, ~production, -->
<!--   2020L,     "P",           5, -->
<!--   2025L,     "P",           5, -->
<!--   2030L,     "P",           5, -->
<!--   2050L,     "P",           5, -->
<!--   2020L,     "S",        11.9, -->
<!--   2025L,     "S",       11.95, -->
<!--   2030L,     "S",          12, -->
<!--   2050L,     "S",        12.1 -->
<!-- ) -->


<!-- data %>% -->
<!--   ggplot(aes(x = year, y = production, group = metric, color = metric)) + -->
<!--   geom_line() + -->
<!--   labs(title = "Trajectories for Two Portfolios", x = "Year", y = "Production") -->
<!-- ``` -->

<!-- the resulting TDM here is:  -->
<!-- ``` {r} -->
<!-- (12 - 5) / (12 - 11.9) -->
<!-- ``` -->

<!-- much much larger than the previous TDM.  -->

<!-- ## Lower limit -->
<!-- The $max(0, ...)$ in this function guarantees that the lower limit is $0$. There are a few ways to reach this lower limit:  -->

<!-- - If $S(t+10) \le P(t+5)$ AND $S(t+10) > S(t)$ -->
<!-- - If $S(t+10) \ge P(t+5)$ AND $S(t+10) < S(t)$ -->

<!-- How can we interpret these edge-cases?  -->

<!-- In the first, we see that $S(t+10) - S(t) > 0$, meaning the scenario increases over a ten-year horizon. In general, increasing scenarios occur if:  -->

<!-- - They are simply projecting that, given current trends, the technology must continue to increase (eg. gas as a transition technology) -->
<!-- - They are stating that the technology SHOULD increase to satisfy a 2-degree aligned future (eg. renewable technologies) -->

<!-- Thus, if the portfolio value $P(t+5)$ is already more ambitious then the scenario value $S(t+10)$ there is no disruption. However, the case is more subtle if the scenario changes it's behaviour outside of the 10 year window (see the next section on **S(t) is not monotonic**).  -->

<!-- In the second case, the interpretation is the opposite. If the scenario decreases, and the portfolio is within the bounds of this decreasing trend, then the resultant disruption is 0. Still, we have the difficulty of potential non-monoticity.  -->

<!-- ## S(t) is not monotonic -->

<!-- TODO: WORK ON THIS -->
