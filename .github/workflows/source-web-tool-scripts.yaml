name: Source web tool scripts in container rocker/verse
on: push
jobs:
  Source-web-tool-scripts:
    container: rocker/verse:4.1.2
    runs-on: ubuntu-latest
    name: Source web tool scripts in container
    strategy:
      fail-fast: false
    env:
      R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:

      - name: install Tex packages
        env:
          CTAN_REPO: https://www.texlive.info/tlnet-archive/2022/01/01/tlnet
          TEX_DEPS: |
            amsmath \
            blindtext \
            bookmark \
            caption \
            fancyhdr \
            geometry \
            grffile \
            hyperref \
            lipsum \
            microtype \
            parskip \
            sectsty \
            silence \
            titlesec \
            unicode-math \
            upquote \
            wrapfig \
            xcolor \
            xurl
        run: tlmgr --repository $CTAN_REPO install $TEX_DEPS

      - name: install package dependencies
        shell: Rscript {0}
        run: |
          install.packages('remotes');
          pkg_deps <- c(
            "bookdown",
            "cli",
            "config",
            "countrycode",
            "devtools",
            "dplyr",
            "forcats",
            "fs",
            "fst",
            "ggplot2",
            "glue",
            "here",
            "janitor",
            "jsonlite",
            "knitr",
            "magrittr",
            "purrr",
            "readr",
            "readxl",
            "rmarkdown",
            "scales",
            "stringi",
            "stringr",
            "tibble",
            "tidyr",
            "vroom",
            "writexl",
            "yaml",
            "zoo"
          );
          remotes::install_cran(pkg_deps, repos = '$CRAN_REPO');

      # When checking out the repository that triggered a workflow, `ref:`
      # defaults to the reference or SHA for that event. Otherwise, uses the
      # default branch --https://github.com/actions/checkout
      - name: Checkout PACTA_analysis
        uses: actions/checkout@v2
        with:
          repository: 2DegreesInvesting/PACTA_analysis
          token: ${{ secrets.MAURO_PAT_FOR_2DII }}
          path: bound
      - name: Checkout pacta-data
        uses: actions/checkout@v2
        with:
          repository: 2DegreesInvesting/pacta-data
          token: ${{ secrets.MAURO_PAT_FOR_2DII }}
          path: pacta-data
      - name: Checkout create_interactive_report
        uses: actions/checkout@v2
        with:
          repository: 2DegreesInvesting/create_interactive_report
          token: ${{ secrets.MAURO_PAT_FOR_2DII }}
          path: create_interactive_report
      - name: Checkout r2dii.climate.stress.test
        uses: actions/checkout@v2
        with:
          repository: 2DegreesInvesting/r2dii.climate.stress.test
          token: ${{ secrets.MAURO_PAT_FOR_2DII }}
          path: r2dii.climate.stress.test
      - name: Checkout r2dii.stress.test.data
        uses: actions/checkout@v2
        with:
          repository: 2DegreesInvesting/r2dii.stress.test.data
          token: ${{ secrets.MAURO_PAT_FOR_2DII }}
          path: r2dii.stress.test.data

      - name: Source web-tool scripts
        run: ./bound/bin/run-r-scripts "TestPortfolio_Input"
