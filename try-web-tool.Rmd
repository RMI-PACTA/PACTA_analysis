---
title: "Mauro's attempt to run the web tool"
date: "`r Sys.Date()`"
output: github_document
---

## Setup

### R

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = "#>",
  collapse = TRUE,
  cache = TRUE
)
```

```{r}
library(testthat)
library(config)
library(rlang)
library(glue)
library(fs)
library(here)
library(tidyverse)
```

### Git

Fork and clone 2DegreesInvesting/PACTA_analysis:

```bash
gh repo fork --clone 2DegreesInvesting/PACTA_analysis
```

```{bash, comment = "$"}
git remote -vv
```

Work on branch `current_web_functionality`.

```{bash, comment = "$"}
git remote show upstream | grep current_web_functionality
```

```{bash, comment = "$"}
git remote show upstream | grep current_web_functionality
```

## [Instructions](https://bit.ly/2RCRJn7)

Now in order to actually run a test portfolio, you need to:

### 1. Copy TestPortfolio_Input.csv from sample_files/20_input_files/ to working_dir/20_Raw_Inputs/

```{r}
# Ensure the source file exists
portfolio_csv <- "TestPortfolio_Input.csv"
from <- here("sample_files", "20_input_files", portfolio_csv)
stopifnot(file_exists(from))

# If it already exists, remove it with a warning
to <- here("working_dir", "20_Raw_Inputs", portfolio_csv)
if (file_exists(to)) {
  warn(glue("Removing existing file: {to}"))
  file_delete(to)
}
```

```{r}
file_copy(from, to)
```

```{r}
expect_true(file_exists(to))
```

### 2. Set "TestPortfolio_Input" as the portfolio_name_ref_all in all three web_tool_scripts (lines 30, 24 and 21)

```{r}
show_pattern_in_file <- function(file, pattern) {
  grep(pattern, readLines(file), value = TRUE)
}
```

```{r}
files <- dir_ls(regexp = "web_tool_script")
this_pattern <- "portfolio_name_ref_all.*<-.*TestPortfolio_Input"
matched <- map(files, show_pattern_in_file, pattern = this_pattern)

walk(matched, writeLines)
```


```{r}
script_has_this_pattern <- grepl(this_pattern, matched)
expect_true(all(script_has_this_pattern))
```

--

Note:

* It seems useful to automate the process of running these files:  `r files` -- for example, via a drake plan, or an rmarkdown document, or a function in a package.

* It seems useful to parametrize these calls: `r matched[[1]]` -- for example, as parameters in a parametrized rmarkdown document, or as arguments to a function.


### 3 Configuration files

#### 3.1. Ensure that there is a config file with name "TestPortfolio_Input_PortfolioParameters.yml" in working_dir/10_Parameter_File/ (this should already be the case, the content should not matter too much, as far as I can tellâ€¦.)

```{r}
config1 <- here(
  "working_dir",
  "10_Parameter_File",
  "TestPortfolio_Input_PortfolioParameters.yml"
)

writeLines(readLines(config1))
```

```{r}
expect_true(file_exists(config1))
```

#### 3.1. Set parameters

Ensure this configuration file exists, as well as all the directories specified in the field `paths`:

```{r}
config2 <- path("parameter_files", "WebParameters_2dii.yml")
writeLines(readLines(config2))
```

```{r}
expect_true(file_exists(config2))
```

```{r}
config2_paths <- config::get(file = config2)$paths
str(config2_paths)
```

```{r}
expect_true(all(map_lgl(config2_paths, dir_exists)))
```

### 4. Run scripts

* web_tool_script_1.R will produce processed input files in working_dir/30_Processed_Inputs/

```{r, error=TRUE, message=FALSE}
source("web_tool_script_1.R")
```

**FIXME: Warning at web_tool_script_1.R#105**

```r
Warning message:
In read_file(paste0(file_location, "/fund_data.fst")) :
  ~/git/pacta-data/2019Q4/cleaned_files/fund_data.fst does not exist
```

Not sure if this dataset is crucial, but it's missing from my clone of pacta-data/:

```{r}
dir_ls(path("..", "pacta-data", "2019Q4", "cleaned_files"))
```

NOTE: A number of calls require parent directories, which should be created if they don't exist. You may do that with something like this:

```{r}
# Compare with `create_portfolio_subfolders()`
create_directory_if_it_doesnt_exist <- function(directory) {
  if (!fs::dir_exists(directory)) {
    fs::dir_create(directory)
  }
  
  invisible(directory)
}

children <- c("30_Processed_Inputs", "40_Results", "50_Outputs")
(paths <- here("working_dir", children))

walk(paths, create_directory_if_it_doesnt_exist)
```

* web_tool_script_2.R will take the processed inputs from the previous step, calculate PACTA results and write them to working_dir/40_Results/

NOTE: I see duplicated code in the first lines of each script. For example, you may extract all calls to `library()` into a file packages.R; and you may also extract the repeated definitions of `working_location` (which I think should be `working_location <- here::here()`).

```{r, error=TRUE, message=FALSE}
source("web_tool_script_2.R")
```




**TODO: Continue exploring below**



* web_tool_script_3.R this will take the results from the previous step plus some pre-calculated data from the pacta-data repo and input these results into the create_interactive_report function.

```{r}
parent <- path_dir(here())
sibling <- path(parent, "create_interactive_report")

if (!dir_exists(sibling)) {
  abort(glue("
    PACTA_analysis/ and create_interactive_report/ must share a parent directory
    See https://git.io/JUBkN
  "))
}

expect_true(dir_exists(sibling))
```

```{r, error=TRUE, message=FALSE}
source("web_tool_script_3.R")
```

If all goes well, this will copy some of the css, js etc files into working_dir/50_Outputs/, along with the results written into the index.html file. It will also produce a zip archive of the results, which is the current not-so-pretty solution to download the report and use everything interactively when offline)

