---
title: "Mauro's attempt to run the web tool"
date: "`r Sys.Date()`"
output: github_document
---

## Setup

### R

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = "#>",
  collapse = TRUE,
  cache = TRUE
)
```

```{r}
library(testthat)
library(config)
library(rlang)
library(glue)
library(fs)
library(here)
library(tidyverse)
```

### Git

Fork and clone 2DegreesInvesting/PACTA_analysis:

```bash
gh repo fork --clone 2DegreesInvesting/PACTA_analysis
```

```{bash, comment = "$"}
git remote -vv
```

Work on branch `current_web_functionality`.

```{bash, comment = "$"}
git remote show upstream | grep current_web_functionality
```

```{bash, comment = "$"}
git remote show upstream | grep current_web_functionality
```

## [Instructions](https://bit.ly/2RCRJn7)

Now in order to actually run a test portfolio, you need to:

### 1. Copy TestPortfolio_Input.csv from sample_files/20_input_files/ to working_dir/20_Raw_Inputs/

```{r}
# Ensure the source file exists
portfolio_csv <- "TestPortfolio_Input.csv"
from <- here("sample_files", "20_input_files", portfolio_csv)
stopifnot(file_exists(from))

# If it already exists, remove it with a warning
to <- here("working_dir", "20_Raw_Inputs", portfolio_csv)
if (file_exists(to)) {
  warn(glue("Removing existing file: {to}"))
  file_delete(to)
}
```

```{r}
file_copy(from, to)
```

```{r}
expect_true(file_exists(to))
```

### 2. Set "TestPortfolio_Input" as the portfolio_name_ref_all in all three web_tool_scripts (lines 30, 24 and 21)

```{r}
show_pattern_in_file <- function(file, pattern) {
  grep(pattern, readLines(file), value = TRUE)
}
```

```{r}
files <- dir_ls(regexp = "web_tool_script")
this_pattern <- "portfolio_name_ref_all.*<-.*TestPortfolio_Input"
matched <- map(files, show_pattern_in_file, pattern = this_pattern)

walk(matched, writeLines)
```


```{r}
script_has_this_pattern <- grepl(this_pattern, matched)
expect_true(all(script_has_this_pattern))
```

--

Note:

* It seems useful to automate the process of running these files:  `r files` -- for example, via a drake plan, or an rmarkdown document, or a function in a package.

* It seems useful to parametrize these calls: `r matched[[1]]` -- for example, as parameters in a parametrized rmarkdown document, or as arguments to a function.


### 3 Configuration files

#### 3.1. Ensure that there is a config file with name "TestPortfolio_Input_PortfolioParameters.yml" in working_dir/10_Parameter_File/ (this should already be the case, the content should not matter too much, as far as I can tellâ€¦.)

```{r}
config1 <- here(
  "working_dir",
  "10_Parameter_File",
  "TestPortfolio_Input_PortfolioParameters.yml"
)

writeLines(readLines(config1))
```

```{r}
expect_true(file_exists(config1))
```

#### 3.1. Set parameters

Ensure this configuration file exists, as well as all the directories specified in the field `paths`:

```{r}
config2 <- path("parameter_files", "WebParameters_2dii.yml")
writeLines(readLines(config2))
```

```{r}
expect_true(file_exists(config2))
```

```{r}
config2_paths <- config::get(file = config2)$paths
str(config2_paths)
```

```{r}
expect_true(all(map_lgl(config2_paths, dir_exists)))
```

### 4. Run scripts

* web_tool_script_1.R will produce processed input files in working_dir/30_Processed_Inputs/

```{r, error=TRUE, message=FALSE}
source("web_tool_script_1.R")
```

**Error at web_tool_script_1.R#32**
 
```r
> traceback()
7: stop("Config file ", basename(file), " not found in current working ", 
       "directory", ifelse(use_parent, " or parent directories", 
    ...
6: config::get(file = file_path) at 0_web_functions.R#77
5: set_web_parameters(file_path = paste0(working_location, "/parameter_files/WebParameters_2dii.yml")) at web_tool_script_1.R#32
4: eval(ei, envir)
3: eval(ei, envir)
2: withVisible(eval(ei, envir))
1: source("web_tool_script_1.R", echo = TRUE)
```

The script behaves differently in an interactive versus non-interactive session. When I knit this document, it runs in a non-interactive session:

```{r}
interactive()
```

This also means that the rstudio API is unavailable (but in this case using the rstudioapi seems a suboptimal solution).

```{r}
rstudioapi::isAvailable()
```

In a non-interactive session, we enter the `else` statement in line 34 of web_tool_script_1.R with looks like this:

```r
portfolio_name_ref_all = get_portfolio_name()
working_location <- getwd()
set_web_parameters(file_path = paste0(working_location,"/parameter_files/WebParameters_docker.yml"))
```

And `get_portfolio_name()` throws an error:

```{r error = TRUE}
get_portfolio_name()
```

This function calls the argument `portfolio_name_ref` that is not defined in the function signature (e.g. there is no `x` in `f <- function(x) { x + 1}`):

```{r}
get_portfolio_name
```

Apparently, it comes from the global environment (which is a bad idea); surprisingly, it is defined in an interactive session but not in a non-interactive session:

```{r}
interactive()

exists("portfolio_name_ref")
```

**FIXME: Warning at web_tool_script_1.R#105**

```r
Warning message:
In read_file(paste0(file_location, "/fund_data.fst")) :
  ~/git/pacta-data/2019Q4/cleaned_files/fund_data.fst does not exist
```

Not sure if this dataset is crucial, but it's missing from my clone of pacta-data/:

```{r}
dir_ls("../pacta-data/2019Q4/cleaned_files/")
```

**FIXME: Error at web_tool_script_1.R#183**

This line expected a directory that didn't exist. Consider adding somethig like this:

```{r}
processed_path <- here("working_dir/30_Processed_Inputs")

if (!dir_exists(processed_path)) {
  dir_create(processed_path)
}
```

**FIXME: Warning at web_tool_script_1.R#105**

This line

```r
create_portfolio_subfolders(file_names, portfolio_name_ref_all)

```

Throws three warnings:

```r
Warning messages:
1: In dir.create(.x) :
  '/home/mauro/git/PACTA_analysis/working_dir//30_Processed_Inputs/TestPortfolio_Input' already exists
```

Maybe create the directory only if it doesn't already exist:

```r
2: In dir.create(.x) :
  cannot create dir '/home/mauro/git/PACTA_analysis/working_dir//40_Results/TestPortfolio_Input', reason 'No such file or directory'
```

Fix with: 

```{r}
results <- here("working_dir", "40_Results")
if (!dir_exists(results)) dir_create(results)
```

```r
3: In dir.create(.x) :
  cannot create dir '/home/mauro/git/PACTA_analysis/working_dir//50_Outputs/TestPortfolio_Input', reason 'No such file or directory'
```
 Fix with: 
 
```{r}
outputs <- here("working_dir", "50_Outputs")
if (!dir_exists(outputs)) dir_create(outputs)
```



* web_tool_script_2.R will take the processed inputs from the previous step, calculate PACTA results and write them to working_dir/40_Results/

```{r, error=TRUE, message=FALSE}
source("web_tool_script_2.R")
```

**FIXME: Error at web_tool_script_2.R#209**

Running this interactively, the line

```r
write_rds(company_all_cb, paste0(pf_file_results, portfolio_name, "_Bonds_results_company.rda")) at web_tool_script_2.R#209
```

throws this error:

```r
Error in saveRDS(x, con) : cannot open the connection
In addition: Warning messages:
1: In dir.create(.x) :
  '/home/mauro/git/PACTA_analysis/working_dir//30_Processed_Inputs/TestPortfolio_Input' already exists
2: In dir.create(.x) :
  cannot create dir '/home/mauro/git/PACTA_analysis/working_dir//40_Results/TestPortfolio_Input', reason 'No such file or directory'
3: In dir.create(.x) :
  cannot create dir '/home/mauro/git/PACTA_analysis/working_dir//50_Outputs/TestPortfolio_Input', reason 'No such file or directory'
4: In dir.create(pf_file_results) :
  cannot create dir '/home/mauro/git/PACTA_analysis/working_dir/40_Results/TestPortfolio_Input', reason 'No such file or directory'
5: In saveRDS(x, con) :
  cannot open file '/home/mauro/git/PACTA_analysis/working_dir/40_Results/TestPortfolio_Input/TestPortfolio_Input_Bonds_results_company.rda': No such file or directory
```

As explained above, I suspect the problem is the double "/" as in "working_dir//40_Results/", or maybe that a required parent directory is missing.






**TODO: Continue exploring below**






* web_tool_script_3.R this will take the results from the previous step plus some pre-calculated data from the pacta-data repo and input these results into the create_interactive_report function.

```{r}
parent <- path_dir(here())
sibling <- path(parent, "create_interactive_report")

if (!dir_exists(sibling)) {
  abort(glue("
    PACTA_analysis/ and create_interactive_report/ must share a parent directory
    See https://git.io/JUBkN
  "))
}

expect_true(dir_exists(sibling))
```

```{r, error=TRUE, message=FALSE}
source("web_tool_script_3.R")
```

If all goes well, this will copy some of the css, js etc files into working_dir/50_Outputs/, along with the results written into the index.html file. It will also produce a zip archive of the results, which is the current not-so-pretty solution to download the report and use everything interactively when offline)

